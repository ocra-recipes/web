\hypertarget{classZmpController}{\section{\-Zmp\-Controller \-Class \-Reference}
\label{classZmpController}\index{\-Zmp\-Controller@{\-Zmp\-Controller}}
}


\-Implementes a \-Z\-M\-P controller as a force set point regulator.  




{\ttfamily \#include $<$\-Zmp\-Controller.\-h$>$}

\subsection*{\-Public \-Member \-Functions}
\begin{DoxyCompactItemize}
\item 
\hyperlink{classZmpController_a4c47608f6d62b6b490808816879c01b7}{\-Zmp\-Controller} (const int period, std\-::shared\-\_\-ptr$<$ ocra\-::\-Model $>$ model\-Ptr, std\-::shared\-\_\-ptr$<$ \hyperlink{structZmpControllerParams}{\-Zmp\-Controller\-Params} $>$ parameters)
\item 
virtual \hyperlink{classZmpController_af308a70e70cfe9a1e9569606da8b1739}{$\sim$\-Zmp\-Controller} ()
\item 
bool \hyperlink{classZmpController_a6fd41771d83a31bd190f4031f82649e0}{compute\-Foot\-Z\-M\-P} (\hyperlink{ZmpController_8h_a4b6a8e135f90bd56e5a57a60efb42529}{\-F\-O\-O\-T} which\-Foot, \-Eigen\-::\-Vector\-Xd wrench, \-Eigen\-::\-Vector2d \&foot\-Z\-M\-P, \-Eigen\-::\-Vector\-Xd \&wrench\-In\-World\-Ref, const double tolerance=1e-\/3)
\item 
bool \hyperlink{classZmpController_aae5cc381a922206dad10ba2d425992ce}{compute\-Global\-Z\-M\-P\-From\-Sensors} (\-Eigen\-::\-Vector\-Xd raw\-Left\-Foot\-Wrench, \-Eigen\-::\-Vector\-Xd raw\-Right\-Foot\-Wrench, \-Eigen\-::\-Vector2d \&global\-Z\-M\-P)
\item 
void \hyperlink{classZmpController_aad272bd33de6fad489ea99618a7e9afa}{get\-F\-T\-Sensor\-Adjoint\-Matrix} (\hyperlink{ZmpController_8h_a4b6a8e135f90bd56e5a57a60efb42529}{\-F\-O\-O\-T} which\-Foot, \-Eigen\-::\-Matrix\-Xd \&\-T, \-Eigen\-::\-Vector3d \&sensor\-Position)
\item 
void \hyperlink{classZmpController_ac8e821f72c79fe86102f02c4c155ad30}{get\-Left\-Foot\-Position} (\-Eigen\-::\-Vector3d \&left\-Foot\-Position)
\item 
void \hyperlink{classZmpController_a815cd495f657cbd93c25610d24982e8c}{get\-Right\-Foot\-Position} (\-Eigen\-::\-Vector3d \&right\-Foot\-Position)
\item 
bool \hyperlink{classZmpController_a5eab881a51fb2ace1a1d494171353bc7}{computehd} (\-Eigen\-::\-Vector2d p, \-Eigen\-::\-Vector2d pd, \-Eigen\-::\-Vector2d \&dhd)
\item 
void \hyperlink{classZmpController_aa450c67048a44fe0dfadf07cd30165e7}{computehdd} (\-Eigen\-::\-Vector3d com\-Position, \-Eigen\-::\-Vector2d global\-Z\-M\-P, \-Eigen\-::\-Vector2d \&ddh)
\item 
void \hyperlink{classZmpController_a3e275de73186b889c755e6dc618d29bf}{computeh} (\-Eigen\-::\-Vector2d prev\-Com\-Position, \-Eigen\-::\-Vector2d prev\-Com\-Vel, \-Eigen\-::\-Vector2d \&int\-Com\-Position)
\item 
ocra\-::\-Task\-State \hyperlink{classZmpController_a7cd490ac7bc0e360c0884cd40a346732}{compute\-Control} (\-Eigen\-::\-Vector2d com\-Ref\-Position, \-Eigen\-::\-Vector2d com\-Ref\-Velocity)
\end{DoxyCompactItemize}
\subsection*{\-Private \-Attributes}
\begin{DoxyCompactItemize}
\item 
std\-::shared\-\_\-ptr\*
$<$ \hyperlink{structZmpControllerParams}{\-Zmp\-Controller\-Params} $>$ \hyperlink{classZmpController_a59a45aafc8a49a0d49966f7ed061a022}{\-\_\-params}
\item 
std\-::shared\-\_\-ptr$<$ ocra\-::\-Model $>$ \hyperlink{classZmpController_ac86a58d1f870ce27c78b0f6d2294e05f}{\-\_\-model}
\end{DoxyCompactItemize}


\subsection{\-Detailed \-Description}
\-Implementes a \-Z\-M\-P controller as a force set point regulator. 

\begin{DoxyAuthor}{\-Author}
\-Jorhabib \-Eljaik
\end{DoxyAuthor}
\cite{krause2012stabilization}

\begin{DoxyWarning}{\-Warning}
\-Work in progress! \-This is still a barebone class in the process of being tested.
\end{DoxyWarning}
\-In \cite{krause2012stabilization} a position-\/based \-Z\-M\-P controller was implemented by relating the desired \-Z\-M\-P $ \mathbf{p}_d $ to a desired force, given the relationship between \-Co\-M acceleration and the \-Z\-M\-P. \-When the dynamical effects of the vertical motion of the robot together with the change of angular momentum are neglected, the horizontal location of the \-Z\-M\-P $\mathbf{p} = (p_x, p_y)$ can be computed as\-: \label{classZmpController_simplifiedZMP}%
\hypertarget{classZmpController_simplifiedZMP}{}%
 \begin{equation} \ddot{h} = \omega^2(\mathbf{h} - \mathbf{p}) \end{equation}

\-Where $\omega = \sqrt{g/c_z}$ as done in \cite{kajita2003biped}. \-Therefore the desired $\mathbf{p}_d$ can be associated to a desired force on the \-Co\-M\-: \[ F_d = m \omega^2 (\mathbf{h} - \mathbf{p}_d) \] \-Where $m$ is the total mass of the robot and a force set point regulator can be implemented as\-: \[ \dot{\mathbf{h}}_d = k_f(F_d - F) \] \-Where $k_f > 0$ is a force control gain. \-Substituting \hyperlink{classZmpController_simplifiedZMP}{simplified\-Z\-M\-P} we get\-: \[ \dot{\mathbf{h}}_d = k_f m \omega^2(\mathbf{p} - \mathbf{p}_d) \]

\begin{DoxySeeAlso}{\-See also}
\hyperlink{classZmpController_a5eab881a51fb2ace1a1d494171353bc7}{computehd()} 
\end{DoxySeeAlso}


\subsection{\-Constructor \& \-Destructor \-Documentation}
\hypertarget{classZmpController_a4c47608f6d62b6b490808816879c01b7}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!\-Zmp\-Controller@{\-Zmp\-Controller}}
\index{\-Zmp\-Controller@{\-Zmp\-Controller}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{\-Zmp\-Controller}]{\setlength{\rightskip}{0pt plus 5cm}{\bf \-Zmp\-Controller\-::\-Zmp\-Controller} (
\begin{DoxyParamCaption}
\item[{const int}]{period, }
\item[{std\-::shared\-\_\-ptr$<$ ocra\-::\-Model $>$}]{model\-Ptr, }
\item[{std\-::shared\-\_\-ptr$<$ {\bf \-Zmp\-Controller\-Params} $>$}]{parameters}
\end{DoxyParamCaption}
)}}\label{classZmpController_a4c47608f6d62b6b490808816879c01b7}
\hypertarget{classZmpController_af308a70e70cfe9a1e9569606da8b1739}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!$\sim$\-Zmp\-Controller@{$\sim$\-Zmp\-Controller}}
\index{$\sim$\-Zmp\-Controller@{$\sim$\-Zmp\-Controller}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{$\sim$\-Zmp\-Controller}]{\setlength{\rightskip}{0pt plus 5cm}{\bf \-Zmp\-Controller\-::$\sim$\-Zmp\-Controller} (
\begin{DoxyParamCaption}
{}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily  \mbox{[}virtual\mbox{]}}}}\label{classZmpController_af308a70e70cfe9a1e9569606da8b1739}


\subsection{\-Member \-Function \-Documentation}
\hypertarget{classZmpController_a7cd490ac7bc0e360c0884cd40a346732}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!compute\-Control@{compute\-Control}}
\index{compute\-Control@{compute\-Control}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{compute\-Control}]{\setlength{\rightskip}{0pt plus 5cm}ocra\-::\-Task\-State {\bf \-Zmp\-Controller\-::compute\-Control} (
\begin{DoxyParamCaption}
\item[{\-Eigen\-::\-Vector2d}]{com\-Ref\-Position, }
\item[{\-Eigen\-::\-Vector2d}]{com\-Ref\-Velocity}
\end{DoxyParamCaption}
)}}\label{classZmpController_a7cd490ac7bc0e360c0884cd40a346732}
\hypertarget{classZmpController_a6fd41771d83a31bd190f4031f82649e0}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!compute\-Foot\-Z\-M\-P@{compute\-Foot\-Z\-M\-P}}
\index{compute\-Foot\-Z\-M\-P@{compute\-Foot\-Z\-M\-P}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{compute\-Foot\-Z\-M\-P}]{\setlength{\rightskip}{0pt plus 5cm}bool {\bf \-Zmp\-Controller\-::compute\-Foot\-Z\-M\-P} (
\begin{DoxyParamCaption}
\item[{{\bf \-F\-O\-O\-T}}]{which\-Foot, }
\item[{\-Eigen\-::\-Vector\-Xd}]{wrench, }
\item[{\-Eigen\-::\-Vector2d \&}]{foot\-Z\-M\-P, }
\item[{\-Eigen\-::\-Vector\-Xd \&}]{wrench\-In\-World\-Ref, }
\item[{const double}]{tolerance = {\ttfamily 1e-\/3}}
\end{DoxyParamCaption}
)}}\label{classZmpController_a6fd41771d83a31bd190f4031f82649e0}
\-Computes the \-Z\-M\-P for a single foot in world reference frame.

\-Assuming that $\mathbf{p}$ is the position of the \-Z\-M\-P for a single foot, $\mathbf{p}_s$ the position of a force torque (\-F/\-T) sensor at the foot, the \-Z\-M\-P position can be computed as\-: \[ \left[\begin{array}{c}p_x \\ p_y \end{array}\right] = \frac{1}{f_z} \left[\begin{array}{cccccc} -p_{s_z} & 0 & p_{s_x} & 0 & -1 & 0 \\ 0 & -p_{s_z} & p_{s_y} & 1 & 0 & 0 \end{array}\right] \left[\begin{array}{c} \mathbf{f}\\ \mathbf{\tau} \end{array}\right] \]


\begin{DoxyParams}[1]{\-Parameters}
 & {\em which\-Foot} & \-L\-E\-F\-T\-\_\-\-F\-O\-O\-T or \-R\-I\-G\-H\-T\-\_\-\-F\-O\-O\-T. \\
\hline
 & {\em wrench} & \-External wrench on the foot as read by the \-F/\-T sensors. \\
\hline
\mbox{\tt out}  & {\em foot\-Z\-M\-P} & \-Foot \-Z\-M\-P in world reference frame. \\
\hline
\mbox{\tt out}  & {\em wrench\-In\-World\-Ref} & \-Transformed wrench in world reference frame. \\
\hline
 & {\em tolerance} & \-Tolerance value below which the \-Z\-M\-P is considered null. \cite{Kajita2014Intro}\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
\-True if all operations proceed successfully. 
\end{DoxyReturn}
\hypertarget{classZmpController_aae5cc381a922206dad10ba2d425992ce}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!compute\-Global\-Z\-M\-P\-From\-Sensors@{compute\-Global\-Z\-M\-P\-From\-Sensors}}
\index{compute\-Global\-Z\-M\-P\-From\-Sensors@{compute\-Global\-Z\-M\-P\-From\-Sensors}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{compute\-Global\-Z\-M\-P\-From\-Sensors}]{\setlength{\rightskip}{0pt plus 5cm}bool {\bf \-Zmp\-Controller\-::compute\-Global\-Z\-M\-P\-From\-Sensors} (
\begin{DoxyParamCaption}
\item[{\-Eigen\-::\-Vector\-Xd}]{raw\-Left\-Foot\-Wrench, }
\item[{\-Eigen\-::\-Vector\-Xd}]{raw\-Right\-Foot\-Wrench, }
\item[{\-Eigen\-::\-Vector2d \&}]{global\-Z\-M\-P}
\end{DoxyParamCaption}
)}}\label{classZmpController_aae5cc381a922206dad10ba2d425992ce}
\-Computes the global \-Z\-M\-P for two feet in contact.

\-After obtaining the \-Z\-M\-P position for both feet $\mathbf{p}_R$ and $\mathbf{p}_L$ independently and expressed in the world reference frame, in the case where both feet are in contact with the ground (or just one), the global expression of the \-Z\-M\-P $\mathbf{p}$ expressed in the world reference frame is\-: \[ \left[\begin{array}{c} p_x\\ p_y \end{array}\right] = \frac{1}{f_{R_z} + f_{L_z}} \left[\begin{array}{cc} \mathbf{p}_R & \mathbf{p}_L \end{array}\right] \left[\begin{array}{c} f_{R_z}\\ f_{L_z} \end{array}\right] \]


\begin{DoxyParams}{\-Parameters}
{\em raw\-Left\-Foot\-Wrench} & \-Raw left foot wrench as read from the sensors \mbox{[}force $|$ torque\mbox{]} \\
\hline
{\em raw\-Right\-Foot\-Wrench} & \-Raw right foot wrench as read from the sensors. \\
\hline
{\em global\-Z\-M\-P} & \-Global zmp in world reference frame considering both feet. @ \cite{Kajita2014Intro}\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{\-Returns}
\-True if all operations succeed, false otherwise. 
\end{DoxyReturn}
\hypertarget{classZmpController_a3e275de73186b889c755e6dc618d29bf}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!computeh@{computeh}}
\index{computeh@{computeh}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{computeh}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf \-Zmp\-Controller\-::computeh} (
\begin{DoxyParamCaption}
\item[{\-Eigen\-::\-Vector2d}]{prev\-Com\-Position, }
\item[{\-Eigen\-::\-Vector2d}]{prev\-Com\-Vel, }
\item[{\-Eigen\-::\-Vector2d \&}]{int\-Com\-Position}
\end{DoxyParamCaption}
)}}\label{classZmpController_a3e275de73186b889c755e6dc618d29bf}
\hypertarget{classZmpController_a5eab881a51fb2ace1a1d494171353bc7}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!computehd@{computehd}}
\index{computehd@{computehd}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{computehd}]{\setlength{\rightskip}{0pt plus 5cm}bool {\bf \-Zmp\-Controller\-::computehd} (
\begin{DoxyParamCaption}
\item[{\-Eigen\-::\-Vector2d}]{p, }
\item[{\-Eigen\-::\-Vector2d}]{pd, }
\item[{\-Eigen\-::\-Vector2d \&}]{dhd}
\end{DoxyParamCaption}
)}}\label{classZmpController_a5eab881a51fb2ace1a1d494171353bc7}
\-Computes the instantaneous desired horizontal \-C\-O\-M velocity for the corresponding desired zmp position.


\begin{DoxyParams}[1]{\-Parameters}
 & {\em p} & \-Horizonal measured zmp position \\
\hline
 & {\em pd} & \-Horizontal desired zmp position \\
\hline
\mbox{\tt out}  & {\em dhd} & \-Horizonal \-Co\-M velocity $\dot{\mathbf{h}}_d$ \\
\hline
\end{DoxyParams}
\hypertarget{classZmpController_aa450c67048a44fe0dfadf07cd30165e7}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!computehdd@{computehdd}}
\index{computehdd@{computehdd}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{computehdd}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf \-Zmp\-Controller\-::computehdd} (
\begin{DoxyParamCaption}
\item[{\-Eigen\-::\-Vector3d}]{com\-Position, }
\item[{\-Eigen\-::\-Vector2d}]{global\-Z\-M\-P, }
\item[{\-Eigen\-::\-Vector2d \&}]{ddh}
\end{DoxyParamCaption}
)}}\label{classZmpController_aa450c67048a44fe0dfadf07cd30165e7}
\hypertarget{classZmpController_aad272bd33de6fad489ea99618a7e9afa}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!get\-F\-T\-Sensor\-Adjoint\-Matrix@{get\-F\-T\-Sensor\-Adjoint\-Matrix}}
\index{get\-F\-T\-Sensor\-Adjoint\-Matrix@{get\-F\-T\-Sensor\-Adjoint\-Matrix}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{get\-F\-T\-Sensor\-Adjoint\-Matrix}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf \-Zmp\-Controller\-::get\-F\-T\-Sensor\-Adjoint\-Matrix} (
\begin{DoxyParamCaption}
\item[{{\bf \-F\-O\-O\-T}}]{which\-Foot, }
\item[{\-Eigen\-::\-Matrix\-Xd \&}]{\-T, }
\item[{\-Eigen\-::\-Vector3d \&}]{sensor\-Position}
\end{DoxyParamCaption}
)}}\label{classZmpController_aad272bd33de6fad489ea99618a7e9afa}
\-Retrieves the \-F\-T sensor adjoint matrix expressed in the world reference frame which multiplied by the local measurement of the sensor gives you the measurement in the world reference.


\begin{DoxyParams}[1]{\-Parameters}
 & {\em which\-Foot} & \-L\-E\-F\-T\-\_\-\-F\-O\-O\-T or \-R\-I\-G\-H\-T\-\_\-\-F\-O\-O\-T \\
\hline
\mbox{\tt out}  & {\em \-T} & \-Adjoint matrix. \\
\hline
\end{DoxyParams}
\hypertarget{classZmpController_ac8e821f72c79fe86102f02c4c155ad30}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!get\-Left\-Foot\-Position@{get\-Left\-Foot\-Position}}
\index{get\-Left\-Foot\-Position@{get\-Left\-Foot\-Position}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{get\-Left\-Foot\-Position}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf \-Zmp\-Controller\-::get\-Left\-Foot\-Position} (
\begin{DoxyParamCaption}
\item[{\-Eigen\-::\-Vector3d \&}]{left\-Foot\-Position}
\end{DoxyParamCaption}
)}}\label{classZmpController_ac8e821f72c79fe86102f02c4c155ad30}
\hypertarget{classZmpController_a815cd495f657cbd93c25610d24982e8c}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!get\-Right\-Foot\-Position@{get\-Right\-Foot\-Position}}
\index{get\-Right\-Foot\-Position@{get\-Right\-Foot\-Position}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{get\-Right\-Foot\-Position}]{\setlength{\rightskip}{0pt plus 5cm}void {\bf \-Zmp\-Controller\-::get\-Right\-Foot\-Position} (
\begin{DoxyParamCaption}
\item[{\-Eigen\-::\-Vector3d \&}]{right\-Foot\-Position}
\end{DoxyParamCaption}
)}}\label{classZmpController_a815cd495f657cbd93c25610d24982e8c}


\subsection{\-Member \-Data \-Documentation}
\hypertarget{classZmpController_ac86a58d1f870ce27c78b0f6d2294e05f}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!\-\_\-model@{\-\_\-model}}
\index{\-\_\-model@{\-\_\-model}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{\-\_\-model}]{\setlength{\rightskip}{0pt plus 5cm}std\-::shared\-\_\-ptr$<$ocra\-::\-Model$>$ {\bf \-Zmp\-Controller\-::\-\_\-model}\hspace{0.3cm}{\ttfamily  \mbox{[}private\mbox{]}}}}\label{classZmpController_ac86a58d1f870ce27c78b0f6d2294e05f}
\hypertarget{classZmpController_a59a45aafc8a49a0d49966f7ed061a022}{\index{\-Zmp\-Controller@{\-Zmp\-Controller}!\-\_\-params@{\-\_\-params}}
\index{\-\_\-params@{\-\_\-params}!ZmpController@{\-Zmp\-Controller}}
\subsubsection[{\-\_\-params}]{\setlength{\rightskip}{0pt plus 5cm}std\-::shared\-\_\-ptr$<${\bf \-Zmp\-Controller\-Params}$>$ {\bf \-Zmp\-Controller\-::\-\_\-params}\hspace{0.3cm}{\ttfamily  \mbox{[}private\mbox{]}}}}\label{classZmpController_a59a45aafc8a49a0d49966f7ed061a022}


\-The documentation for this class was generated from the following files\-:\begin{DoxyCompactItemize}
\item 
ocra-\/wbi-\/plugins/ocra-\/icub-\/clients/walking-\/client/include/walking-\/client/\hyperlink{ZmpController_8h}{\-Zmp\-Controller.\-h}\item 
ocra-\/wbi-\/plugins/ocra-\/icub-\/clients/walking-\/client/src/\hyperlink{ZmpController_8cpp}{\-Zmp\-Controller.\-cpp}\end{DoxyCompactItemize}
